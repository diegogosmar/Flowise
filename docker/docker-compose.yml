version: '3.1'

services:
  flowise:
    image: flowiseai/flowise
    restart: always
    environment:
      - PORT=${PORT}

      # DATABASE
      - DATABASE_PATH=${DATABASE_PATH}
      - DATABASE_TYPE=${DATABASE_TYPE}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_SSL=${DATABASE_SSL}
      - DATABASE_SSL_KEY_BASE64=${DATABASE_SSL_KEY_BASE64}

      # SECRET KEYS
      - SECRETKEY_STORAGE_TYPE=${SECRETKEY_STORAGE_TYPE}
      - SECRETKEY_PATH=${SECRETKEY_PATH}
      - FLOWISE_SECRETKEY_OVERWRITE=${FLOWISE_SECRETKEY_OVERWRITE}
      - SECRETKEY_AWS_ACCESS_KEY=${SECRETKEY_AWS_ACCESS_KEY}
      - SECRETKEY_AWS_SECRET_KEY=${SECRETKEY_AWS_SECRET_KEY}
      - SECRETKEY_AWS_REGION=${SECRETKEY_AWS_REGION}
      - SECRETKEY_AWS_NAME=${SECRETKEY_AWS_NAME}

      # LOGGING
      - DEBUG=${DEBUG}
      - LOG_PATH=${LOG_PATH}
      - LOG_LEVEL=${LOG_LEVEL}

      # CUSTOM TOOL DEPENDENCIES
      - TOOL_FUNCTION_BUILTIN_DEP=${TOOL_FUNCTION_BUILTIN_DEP}
      - TOOL_FUNCTION_EXTERNAL_DEP=${TOOL_FUNCTION_EXTERNAL_DEP}

      # STORAGE
      - STORAGE_TYPE=${STORAGE_TYPE}
      - BLOB_STORAGE_PATH=${BLOB_STORAGE_PATH}
      - S3_STORAGE_BUCKET_NAME=${S3_STORAGE_BUCKET_NAME}
      - S3_STORAGE_ACCESS_KEY_ID=${S3_STORAGE_ACCESS_KEY_ID}
      - S3_STORAGE_SECRET_ACCESS_KEY=${S3_STORAGE_SECRET_ACCESS_KEY}
      - S3_STORAGE_REGION=${S3_STORAGE_REGION}
      - S3_ENDPOINT_URL=${S3_ENDPOINT_URL}
      - S3_FORCE_PATH_STYLE=${S3_FORCE_PATH_STYLE}
      - GOOGLE_CLOUD_STORAGE_CREDENTIAL=${GOOGLE_CLOUD_STORAGE_CREDENTIAL}
      - GOOGLE_CLOUD_STORAGE_PROJ_ID=${GOOGLE_CLOUD_STORAGE_PROJ_ID}
      - GOOGLE_CLOUD_STORAGE_BUCKET_NAME=${GOOGLE_CLOUD_STORAGE_BUCKET_NAME}
      - GOOGLE_CLOUD_UNIFORM_BUCKET_ACCESS=${GOOGLE_CLOUD_UNIFORM_BUCKET_ACCESS}

      # SETTINGS
      - NUMBER_OF_PROXIES=${NUMBER_OF_PROXIES}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - IFRAME_ORIGINS=${IFRAME_ORIGINS}
      - FLOWISE_FILE_SIZE_LIMIT=${FLOWISE_FILE_SIZE_LIMIT}
      - SHOW_COMMUNITY_NODES=${SHOW_COMMUNITY_NODES}
      - DISABLE_FLOWISE_TELEMETRY=${DISABLE_FLOWISE_TELEMETRY}
      - DISABLED_NODES=${DISABLED_NODES}
      - MODEL_LIST_CONFIG_JSON=${MODEL_LIST_CONFIG_JSON}

      # AUTH PARAMETERS
      - APP_URL=${APP_URL}
      - JWT_AUTH_TOKEN_SECRET=${JWT_AUTH_TOKEN_SECRET}
      - JWT_REFRESH_TOKEN_SECRET=${JWT_REFRESH_TOKEN_SECRET}
      - JWT_ISSUER=${JWT_ISSUER}
      - JWT_AUDIENCE=${JWT_AUDIENCE}
      - JWT_TOKEN_EXPIRY_IN_MINUTES=${JWT_TOKEN_EXPIRY_IN_MINUTES}
      - JWT_REFRESH_TOKEN_EXPIRY_IN_MINUTES=${JWT_REFRESH_TOKEN_EXPIRY_IN_MINUTES}
      - EXPIRE_AUTH_TOKENS_ON_RESTART=${EXPIRE_AUTH_TOKENS_ON_RESTART}
      - EXPRESS_SESSION_SECRET=${EXPRESS_SESSION_SECRET}
      - PASSWORD_RESET_TOKEN_EXPIRY_IN_MINS=${PASSWORD_RESET_TOKEN_EXPIRY_IN_MINS}
      - PASSWORD_SALT_HASH_ROUNDS=${PASSWORD_SALT_HASH_ROUNDS}
      - TOKEN_HASH_SECRET=${TOKEN_HASH_SECRET}

      # EMAIL
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_SECURE=${SMTP_SECURE}
      - ALLOW_UNAUTHORIZED_CERTS=${ALLOW_UNAUTHORIZED_CERTS}
      - SENDER_EMAIL=${SENDER_EMAIL}

      # ENTERPRISE
      - LICENSE_URL=${LICENSE_URL}
      - FLOWISE_EE_LICENSE_KEY=${FLOWISE_EE_LICENSE_KEY}
      - OFFLINE=${OFFLINE}
      - INVITE_TOKEN_EXPIRY_IN_HOURS=${INVITE_TOKEN_EXPIRY_IN_HOURS}
      - WORKSPACE_INVITE_TEMPLATE_PATH=${WORKSPACE_INVITE_TEMPLATE_PATH}

      # METRICS COLLECTION
      - POSTHOG_PUBLIC_API_KEY=${POSTHOG_PUBLIC_API_KEY}
      - ENABLE_METRICS=${ENABLE_METRICS}
      - METRICS_PROVIDER=${METRICS_PROVIDER}
      - METRICS_INCLUDE_NODE_METRICS=${METRICS_INCLUDE_NODE_METRICS}
      - METRICS_SERVICE_NAME=${METRICS_SERVICE_NAME}
      - METRICS_OPEN_TELEMETRY_METRIC_ENDPOINT=${METRICS_OPEN_TELEMETRY_METRIC_ENDPOINT}
      - METRICS_OPEN_TELEMETRY_PROTOCOL=${METRICS_OPEN_TELEMETRY_PROTOCOL}
      - METRICS_OPEN_TELEMETRY_DEBUG=${METRICS_OPEN_TELEMETRY_DEBUG}

    ports:
      - '${PORT}:${PORT}'

    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${PORT}/api/v1/ping']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    volumes:
      - ~/.flowise:/root/.flowise

    entrypoint: ["/bin/sh", "-c"]

    command:
      - |
         echo Replacing flowise titles and images...
         sed -i 's/Flowise - Build AI Agents, Visually/Cicero Agentic AI/g' /usr/local/lib/node_modules/flowise/node_modules/flowise-ui/index.html
         sed -i 's/Flowise - Build AI Agents, Visually/Cicero Agentic AI/g' /usr/local/lib/node_modules/flowise/node_modules/flowise-ui/build/index.html
         echo '<svg xmlns="http://www.w3.org/2000/svg" width="2360" height="1000" xmlns:v="https://vecta.io/nano"><defs><linearGradient id="A" gradientUnits="userSpaceOnUse" x1="1180.005" x2="1180.005" y1="100.235" y2="899.763"><stop offset="0" stop-color="#a03a8d"/><stop offset="1" stop-color="#1f3c8d"/></linearGradient></defs><path d="M1579.765 499.991c0-79.472-23.273-156.257-67.297-222.044-3.052-4.578-9.223-5.806-13.801-2.737a9.96 9.96 0 0 0-2.737 13.801c41.818 62.503 63.929 135.456 63.929 210.98 0 209.454-170.389 379.86-379.86 379.86-67.927 0-133.83-17.898-191.871-51.953l32.313-8.659c5.308-1.427 8.46-6.884 7.033-12.192s-6.884-8.443-12.192-7.033l-54.375 14.564c-5.308 1.427-8.46 6.884-7.033 12.192l14.564 54.375c1.194 4.446 5.208 7.365 9.604 7.365a9.98 9.98 0 0 0 2.588-.332c5.308-1.427 8.46-6.884 7.033-12.192l-8.045-30.007c60.728 35.249 129.501 53.778 200.38 53.778 106.775 0 207.181-41.586 282.672-117.093 75.507-75.491 117.093-175.88 117.093-282.672zM1151.204 797.36c-10.533 4.246-20.254 6.021-29.195 6.055h-1.626c-32.695-.614-54.242-24.716-63.415-37.588-23.223-32.529-26.557-71.161-14.033-83.951 11.081-11.313 36.36-4.927 69.353 17.55 4.545 3.085 10.732 1.924 13.834-2.621 3.085-4.545 1.924-10.732-2.621-13.834-54.308-36.991-81.512-28.581-94.799-15.012-8.36 8.543-12.292 20.536-12.839 33.939-2.223.332-4.479.514-6.718.514-31.799 0-57.676-32.794-57.676-73.135 0-40.308 25.877-73.119 57.676-73.119 5.507 0 9.953-4.462 9.953-9.953a9.94 9.94 0 0 0-9.953-9.953c-29.609 0-55.386 20.005-68.474 49.315-19.375-8.592-32.744-30.057-32.744-54.159 0-19.292 8.46-37.289 22.626-48.154 2.803-2.14 4.246-5.607 3.815-9.107s-2.671-6.502-5.922-7.912c-19.773-8.576-33.059-30.405-33.059-54.308 0-30.306 20.635-55.254 46.86-57.908 6.718 37.273 30.571 67.628 62.586 77.266.962.282 1.924.415 2.87.415 4.28 0 8.227-2.77 9.521-7.083 1.592-5.258-1.41-10.815-6.668-12.391-29.626-8.924-50.311-41.685-50.311-79.671 0-45.185 29.493-81.943 65.737-81.943 8.841 0 17.417 2.156 25.512 6.436 4.86 2.571 10.881.713 13.453-4.147.78-1.476 1.145-3.069 1.145-4.645v-.066-.05-.066c0-28.398 23.107-51.505 51.505-51.505 12.457 0 24.235 4.396 33.574 12.457V797.36zm-70.432-334.16c17.765 28.017 24.434 54.159 20.353 79.936-3.5 22.045-14.979 43.41-35.083 65.273-1.957 2.14-4.645 3.218-7.332 3.218-2.405 0-4.827-.863-6.735-2.621-4.047-3.716-4.313-10.019-.597-14.066 36.576-39.777 40.441-77.133 12.574-121.074a9.94 9.94 0 0 1 3.069-13.735 9.96 9.96 0 0 1 13.751 3.069zm13.602-66.882c-19.955-5.424-34.917-23.123-38.119-45.102-2.057-14.083 1.012-28.1 8.609-39.446 7.813-11.678 19.457-19.175 32.777-21.116 1.078-.149 2.173-.282 3.268-.365 5.474-.415 10.251 3.699 10.666 9.19.398 5.491-3.699 10.251-9.19 10.666a35.33 35.33 0 0 0-1.858.199c-7.68 1.111-14.465 5.557-19.109 12.491-4.86 7.249-6.801 16.322-5.457 25.512 2.024 13.917 11.528 25.479 23.638 28.763 5.308 1.443 8.427 6.917 7 12.209-1.211 4.429-5.209 7.348-9.604 7.348-.879 0-1.742-.116-2.621-.348zm311.85-80.368c2.073 2.073 2.405 5.126.813 7.597l-31.484 48.718c-5.026 7.78-5.607 17.036-1.592 25.396 3.815 7.879 7.199 16.057 10.069 24.268 3.069 8.725 10.019 14.863 19.059 16.803l56.68 12.175c2.87.614 4.794 3.002 4.794 5.938v86.306c0 2.936-1.924 5.325-4.794 5.938l-56.68 12.175c-9.057 1.941-15.991 8.062-19.059 16.803a239.02 239.02 0 0 1-10.069 24.268c-4.031 8.36-3.45 17.6 1.576 25.396l31.484 48.702c1.592 2.472 1.277 5.524-.813 7.597l-61.026 61.026c-2.073 2.09-5.142 2.405-7.597.813l-48.718-31.484c-7.78-5.026-17.036-5.607-25.396-1.576a235.91 235.91 0 0 1-24.268 10.069c-8.725 3.069-14.863 10.002-16.803 19.059l-12.175 56.68c-.614 2.87-3.002 4.794-5.938 4.794h-33.192V673.167c91.034-5.175 163.505-80.865 163.505-173.176s-72.472-167.984-163.505-173.16V204.68c0-2.737-1.111-5.225-2.903-7.033-.017 0-.017-.017-.033-.017-.365-.365-.746-.697-1.111-1.062h37.239c2.936 0 5.325 1.924 5.938 4.81l12.175 56.68c1.941 9.057 8.062 15.991 16.803 19.059 8.211 2.886 16.372 6.27 24.268 10.069 8.36 4.031 17.6 3.45 25.396-1.592l48.718-31.484c2.472-1.592 5.524-1.277 7.597.813zm-7.133-130.529l-54.375 14.564a9.89 9.89 0 0 1-2.588.332 9.94 9.94 0 0 1-9.604-7.382c-1.427-5.308 1.725-10.765 7.033-12.192l32.313-8.659c-58.041-34.055-123.944-51.953-191.871-51.953-209.453 0-379.859 170.406-379.859 379.86 0 75.524 22.111 148.477 63.929 210.98 3.069 4.578 1.841 10.749-2.737 13.818-1.709 1.145-3.616 1.675-5.524 1.675-3.218 0-6.353-1.559-8.277-4.412-44.024-65.787-67.297-142.572-67.297-222.044 0-106.775 41.586-207.164 117.093-282.672S1073.225 100.243 1180 100.243c70.879 0 139.652 18.529 200.38 53.794l-8.045-30.024c-1.427-5.308 1.725-10.765 7.033-12.192s10.765 1.725 12.192 7.033l14.564 54.358c1.427 5.325-1.725 10.782-7.033 12.209z" fill="url(#A)" fill-rule="evenodd"/></svg>' > /usr/local/lib/node_modules/flowise/node_modules/flowise-ui/build/assets/flowise_dark-Db3DSKPp.svg
         echo '<svg xmlns="http://www.w3.org/2000/svg" width="2360" height="1000" xmlns:v="https://vecta.io/nano"><defs><linearGradient id="A" gradientUnits="userSpaceOnUse" x1="1180.005" x2="1180.005" y1="100.235" y2="899.763"><stop offset="0" stop-color="#a03a8d"/><stop offset="1" stop-color="#1f3c8d"/></linearGradient></defs><path d="M1579.765 499.992c0-79.472-23.273-156.257-67.297-222.044-3.052-4.578-9.223-5.806-13.801-2.737a9.96 9.96 0 0 0-2.737 13.801c41.818 62.503 63.929 135.456 63.929 210.98 0 209.454-170.389 379.86-379.86 379.86-67.927 0-133.83-17.898-191.871-51.953l32.313-8.659c5.308-1.427 8.46-6.884 7.033-12.192s-6.884-8.443-12.192-7.033l-54.375 14.564c-5.308 1.427-8.46 6.884-7.033 12.192l14.564 54.375c1.194 4.446 5.208 7.365 9.604 7.365a9.98 9.98 0 0 0 2.588-.332c5.308-1.427 8.46-6.884 7.033-12.192l-8.045-30.007c60.728 35.249 129.501 53.778 200.38 53.778 106.775 0 207.181-41.586 282.672-117.093 75.507-75.491 117.093-175.88 117.093-282.672zM1151.204 797.36c-10.533 4.246-20.254 6.021-29.195 6.055h-1.626c-32.695-.614-54.242-24.716-63.415-37.588-23.223-32.529-26.557-71.161-14.033-83.951 11.081-11.313 36.36-4.927 69.353 17.55 4.545 3.085 10.732 1.924 13.834-2.621 3.085-4.545 1.924-10.732-2.621-13.834-54.308-36.991-81.512-28.581-94.799-15.012-8.36 8.543-12.292 20.536-12.839 33.939-2.223.332-4.479.514-6.718.514-31.799 0-57.676-32.794-57.676-73.135 0-40.308 25.877-73.119 57.676-73.119 5.507 0 9.953-4.462 9.953-9.953a9.94 9.94 0 0 0-9.953-9.953c-29.609 0-55.386 20.005-68.474 49.315-19.374-8.592-32.744-30.057-32.744-54.159 0-19.292 8.46-37.289 22.626-48.154a9.92 9.92 0 0 0 3.815-9.107c-.431-3.5-2.671-6.502-5.922-7.912-19.773-8.576-33.059-30.405-33.059-54.308 0-30.306 20.635-55.254 46.86-57.908 6.718 37.273 30.571 67.628 62.586 77.266.962.282 1.924.415 2.87.415 4.28 0 8.227-2.77 9.521-7.083 1.592-5.258-1.41-10.815-6.668-12.391-29.626-8.924-50.311-41.685-50.311-79.671 0-45.185 29.493-81.943 65.737-81.943 8.841 0 17.417 2.156 25.512 6.436 4.86 2.571 10.881.713 13.453-4.147a9.91 9.91 0 0 0 1.145-4.645v-.066-.05-.066c0-28.398 23.107-51.505 51.505-51.505 12.457 0 24.235 4.396 33.574 12.457V797.36zm-70.432-334.16c17.765 28.017 24.434 54.159 20.353 79.936-3.5 22.045-14.979 43.41-35.083 65.273-1.957 2.14-4.645 3.218-7.332 3.218a9.91 9.91 0 0 1-6.735-2.621c-4.047-3.716-4.313-10.019-.597-14.066 36.576-39.777 40.441-77.133 12.574-121.074a9.94 9.94 0 0 1 3.069-13.735 9.96 9.96 0 0 1 13.751 3.069zm13.602-66.882c-19.955-5.424-34.917-23.123-38.119-45.102-2.057-14.083 1.012-28.1 8.609-39.446 7.813-11.678 19.457-19.175 32.777-21.116 1.078-.149 2.173-.282 3.268-.365 5.474-.415 10.251 3.699 10.666 9.19.398 5.491-3.699 10.251-9.19 10.666a35.33 35.33 0 0 0-1.858.199c-7.68 1.111-14.465 5.557-19.109 12.491-4.86 7.249-6.801 16.322-5.457 25.512 2.024 13.917 11.528 25.479 23.638 28.763 5.308 1.443 8.427 6.917 7 12.209-1.211 4.429-5.209 7.348-9.604 7.348-.879 0-1.742-.116-2.621-.348zm311.85-80.368c2.073 2.073 2.405 5.126.813 7.597l-31.484 48.718c-5.026 7.78-5.607 17.036-1.592 25.396 3.815 7.879 7.199 16.057 10.069 24.268 3.069 8.725 10.019 14.863 19.059 16.803l56.68 12.175c2.87.614 4.794 3.002 4.794 5.938v86.306c0 2.936-1.924 5.325-4.794 5.938l-56.68 12.175c-9.057 1.941-15.991 8.062-19.059 16.803a239.02 239.02 0 0 1-10.069 24.268c-4.031 8.36-3.45 17.6 1.576 25.396l31.484 48.702c1.592 2.472 1.277 5.524-.813 7.597l-61.026 61.026c-2.073 2.09-5.142 2.405-7.597.813l-48.718-31.484c-7.78-5.026-17.036-5.607-25.396-1.576a235.91 235.91 0 0 1-24.268 10.069c-8.725 3.069-14.863 10.002-16.803 19.059l-12.175 56.68c-.614 2.87-3.002 4.794-5.938 4.794h-33.192V673.168c91.034-5.175 163.505-80.865 163.505-173.176s-72.472-167.984-163.505-173.16V204.68a9.97 9.97 0 0 0-2.903-7.033c-.017 0-.017-.017-.033-.017-.365-.365-.746-.697-1.111-1.062h37.239c2.936 0 5.325 1.924 5.938 4.81l12.175 56.68c1.941 9.057 8.062 15.991 16.803 19.059 8.211 2.886 16.372 6.27 24.268 10.069 8.36 4.031 17.6 3.45 25.396-1.592l48.718-31.484c2.472-1.592 5.524-1.277 7.597.813zm-7.133-130.529l-54.375 14.564a9.89 9.89 0 0 1-2.588.332 9.94 9.94 0 0 1-9.604-7.382c-1.427-5.308 1.725-10.765 7.033-12.192l32.313-8.659c-58.041-34.055-123.944-51.953-191.871-51.953-209.454 0-379.859 170.406-379.859 379.86 0 75.524 22.111 148.477 63.929 210.98a9.95 9.95 0 0 1-2.737 13.818 9.84 9.84 0 0 1-5.524 1.675c-3.218 0-6.353-1.559-8.277-4.412-44.023-65.787-67.296-142.572-67.296-222.044 0-106.775 41.585-207.164 117.093-282.672S1073.225 100.243 1180 100.243c70.879 0 139.652 18.529 200.38 53.794l-8.045-30.024c-1.427-5.308 1.725-10.765 7.033-12.192s10.765 1.725 12.192 7.033l14.564 54.358c1.427 5.325-1.725 10.782-7.033 12.209z" fill="url(#A)" fill-rule="evenodd"/></svg>' > /usr/local/lib/node_modules/flowise/node_modules/flowise-ui/build/assets/flowise_white-DsHGi9nE.svg
         echo Done
         echo Starting flowise
         flowise start
